<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pac-Man Navideño | Versión Final Corregida</title>
    <style>
        :root { --noche: #0A192F; --adviento: #6A0573; --oro: #FFD700; --nieve: #F0F8FF; }
        body { margin: 0; background-color: var(--noche); font-family: sans-serif; color: var(--nieve); display: flex; flex-direction: column; align-items: center; overflow: hidden; touch-action: none; }
        #game-header { width: 100%; padding: 10px; background: var(--adviento); display: flex; justify-content: space-around; border-bottom: 3px solid var(--oro); }
        .stat-box { font-size: 1.1rem; font-weight: bold; }
        #game-container { position: relative; margin-top: 10px; border: 4px solid var(--adviento); background: #000; line-height: 0; }
        canvas { display: block; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; text-align: center; }
        .btn { background: var(--adviento); color: white; border: 2px solid var(--oro); padding: 15px 30px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; margin-top: 20px; }
        #controls { display: grid; grid-template-columns: repeat(3, 65px); gap: 10px; margin-top: 15px; }
        .ctrl-btn { background: rgba(255,255,255,0.1); border: 2px solid var(--oro); border-radius: 15px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: var(--oro); }
    </style>
</head>
<body>

    <div id="game-header">
        <div class="stat-box">Nivel: <span id="lvl-val">1</span></div>
        <div class="stat-box">Vidas: <span id="lives-val">3</span></div>
        <div class="stat-box">Puntos: <span id="score-val">0</span></div>
    </div>

    <div id="game-container">
        <canvas id="pacCanvas"></canvas>
    </div>

    <div id="menu-screen" class="overlay">
        <h1 style="color:var(--oro)">CAMINO A BELÉN</h1>
        <button class="btn" onclick="startGame()">EMPEZAR JUEGO</button>
    </div>

    <div id="msg-screen" class="overlay" style="display: none;">
        <h1 id="msg-title" style="color:var(--oro)"></h1>
        <p id="msg-body" style="font-size: 1.5rem;"></p>
        <button class="btn" id="msg-btn">CONTINUAR</button>
    </div>

    <div id="controls">
        <div style="grid-column: 2" class="ctrl-btn" onmousedown="setDir(0, -1)" ontouchstart="setDir(0, -1)">↑</div>
        <div style="grid-row: 2; grid-column: 1" class="ctrl-btn" onmousedown="setDir(-1, 0)" ontouchstart="setDir(-1, 0)">←</div>
        <div style="grid-row: 2; grid-column: 2" class="ctrl-btn" onmousedown="setDir(0, 1)" ontouchstart="setDir(0, 1)">↓</div>
        <div style="grid-row: 2; grid-column: 3" class="ctrl-btn" onmousedown="setDir(1, 0)" ontouchstart="setDir(1, 0)">→</div>
    </div>

    <script>
        const canvas = document.getElementById('pacCanvas');
        const ctx = canvas.getContext('2d');
        const TILE = 20;
        
        let score = 0, level = 1, lives = 3, gameActive = false;
        let ghosts = [];
        let map = [];

        const layout = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,3,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,3,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
            [1,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,1],
            [1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],
            [0,0,0,0,0,2,2,1,2,2,2,1,2,2,0,0,0,0,0],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
            [1,2,2,1,0,1,2,2,2,4,2,2,2,1,0,1,2,2,1],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,3,0,1,0,0,0,0,0,2,0,0,0,0,0,1,0,3,1],
            [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const player = { x: 9*TILE, y: 15*TILE, dx: 0, dy: 0, nextDx: 0, nextDy: 0, speed: 2, power: 0 };

        function initLevel() {
            map = JSON.parse(JSON.stringify(layout));
            ghosts = [];
            const colors = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
            const speed = 1.5 + (level * 0.2);
            for(let i=0; i<4; i++) {
                ghosts.push({ x: 9*TILE, y: 9*TILE, dx: 0, dy: 0, color: colors[i], speed: speed, scared: false });
            }
            player.x = 9*TILE; player.y = 15*TILE; player.dx = 0; player.dy = 0;
        }

        function setDir(x, y) { player.nextDx = x; player.nextDy = y; }

        function update() {
            if(!gameActive) return;

            // Movimiento Jugador (Bloqueado por paredes)
            if(player.x % TILE === 0 && player.y % TILE === 0) {
                const cx = player.x / TILE, cy = player.y / TILE;
                if(map[cy + player.nextDy] && map[cy + player.nextDy][cx + player.nextDx] !== 1) {
                    player.dx = player.nextDx; player.dy = player.nextDy;
                }
                if(map[cy + player.dy] && map[cy + player.dy][cx + player.dx] === 1) {
                    player.dx = 0; player.dy = 0;
                }
                if(map[cy][cx] === 0) { map[cy][cx] = 2; score += 10; checkWin(); }
                if(map[cy][cx] === 3) { map[cy][cx] = 2; score += 50; player.power = 400; ghosts.forEach(g => g.scared = true); }
            }
            player.x += player.dx * player.speed;
            player.y += player.dy * player.speed;

            // Túneles
            if(player.x < 0) player.x = canvas.width - TILE;
            if(player.x >= canvas.width) player.x = 0;

            // Movimiento Fantasmas (IA Reforzada para no salirse)
            ghosts.forEach(g => {
                if(Math.abs(g.x % TILE) < g.speed && Math.abs(g.y % TILE) < g.speed) {
                    g.x = Math.round(g.x / TILE) * TILE;
                    g.y = Math.round(g.y / TILE) * TILE;
                    const gx = g.x / TILE, gy = g.y / TILE;
                    
                    const options = [[0,1],[0,-1],[1,0],[-1,0]].filter(d => {
                        return map[gy + d[1]] && map[gy + d[1]][gx + d[0]] !== 1;
                    });

                    let choice = options.filter(d => !(d[0] === -g.dx && d[1] === -g.dy));
                    let final = (choice.length > 0 ? choice : options)[Math.floor(Math.random() * (choice.length > 0 ? choice : options).length)];
                    if(final) { g.dx = final[0]; g.dy = final[1]; }
                }
                g.x += g.dx * g.speed;
                g.y += g.dy * g.speed;

                // Colisión (Solo si no son atravesables)
                if(Math.hypot(player.x - g.x, player.y - g.y) < TILE * 0.8) {
                    if(g.scared) { g.x = 9*TILE; g.y = 9*TILE; score += 200; g.scared = false; }
                    else { triggerGameOver(); }
                }
            });

            if(player.power > 0) { player.power--; if(player.power === 0) ghosts.forEach(g => g.scared = false); }
            document.getElementById('score-val').innerText = score;
        }

        function triggerGameOver() {
            gameActive = false; // Parar el juego de inmediato
            lives--;
            document.getElementById('lives-val').innerText = lives;
            
            if(lives > 0) {
                showAlert("¡AY!", "Te han atrapado. Quedan " + lives + " vidas.", "REINTENTAR", () => {
                    initLevel(); 
                    gameActive = true;
                });
            } else {
                showAlert("FIN DEL JUEGO", "Se acabaron las vidas. Puntos: " + score, "REINICIAR", () => location.reload());
            }
        }

        function checkWin() {
            let dots = 0; map.forEach(r => r.forEach(c => { if(c === 0) dots++; }));
            if(dots === 0) {
                gameActive = false;
                level++;
                showAlert("¡NIVEL SUPERADO!", "Entrando al nivel " + level, "SIGUIENTE", () => {
                    initLevel();
                    document.getElementById('lvl-val').innerText = level;
                    gameActive = true;
                });
            }
        }

        function showAlert(t, b, bt, action) {
            const screen = document.getElementById('msg-screen');
            document.getElementById('msg-title').innerText = t;
            document.getElementById('msg-body').innerText = b;
            const btn = document.getElementById('msg-btn');
            btn.innerText = bt;
            btn.onclick = () => { screen.style.display = 'none'; action(); };
            screen.style.display = 'flex';
        }

        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            for(let y=0; y<map.length; y++) {
                for(let x=0; x<map[y].length; x++) {
                    if(map[y][x] === 1) { ctx.fillStyle = '#10294c'; ctx.fillRect(x*20+2, y*20+2, 16, 16); }
                    else if(map[y][x] === 0) { ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(x*20+10, y*20+10, 2, 0, 7); ctx.fill(); }
                    else if(map[y][x] === 3) { ctx.fillStyle = '#FF0'; ctx.beginPath(); ctx.arc(x*20+10, y*20+10, 5, 0, 7); ctx.fill(); }
                }
            }
            // Pacman
            ctx.fillStyle = player.power > 0 ? '#FFF' : '#FFD700';
            ctx.beginPath(); let a = (Math.sin(Date.now()/100)+1)*0.2;
            ctx.arc(player.x+10, player.y+10, 8, a*Math.PI, (2-a)*Math.PI);
            ctx.lineTo(player.x+10, player.y+10); ctx.fill();
            // Fantasmas
            ghosts.forEach(g => {
                ctx.fillStyle = g.scared ? '#4a69bd' : g.color;
                ctx.beginPath(); ctx.arc(g.x+10, g.y+10, 8, Math.PI, 0);
                ctx.lineTo(g.x+18, g.y+18); ctx.lineTo(g.x+2, g.y+18); ctx.fill();
            });
            if(gameActive) requestAnimationFrame(draw);
        }

        function startGame() {
            document.getElementById('menu-screen').style.display = 'none';
            canvas.width = 19 * TILE; canvas.height = 19 * TILE;
            initLevel();
            gameActive = true;
            setInterval(update, 1000/60); // Lógica a 60fps fijos
            draw();
        }
    </script>
</body>
</html>
