<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pac-Man Navideño | La Luz de Adviento</title>
    <style>
        /* --- ESTILO BASE (Basado en tu código previo) --- */
        :root {
            --noche: #0A192F;
            --adviento: #6A0573;
            --oro: #FFD700;
            --nieve: #F0F8FF;
            --rojo: #990011;
        }

        body {
            margin: 0;
            background-color: var(--noche);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--nieve);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            touch-action: none;
        }

        /* --- UI DEL JUEGO --- */
        #game-header {
            width: 100%;
            padding: 15px;
            background: var(--adviento);
            display: flex;
            justify-content: space-around;
            border-bottom: 3px solid var(--oro);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .stat-box { font-size: 1.2rem; font-weight: bold; }
        .stat-box span { color: var(--oro); }

        #game-container {
            position: relative;
            margin-top: 20px;
            box-shadow: 0 0 30px rgba(106, 5, 115, 0.5);
            border: 4px solid var(--adviento);
            border-radius: 10px;
        }

        canvas { display: block; background-color: #000; }

        /* --- MENÚS Y PANTALLAS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 25, 47, 0.95);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 100; text-align: center;
            padding: 20px;
        }

        h1 { color: var(--oro); font-size: 3rem; text-shadow: 0 0 20px var(--rojo); margin-bottom: 10px; }
        p { font-size: 1.2rem; max-width: 500px; line-height: 1.5; }

        .btn {
            background: var(--adviento); color: white; border: 2px solid var(--oro);
            padding: 15px 40px; font-size: 1.5rem; border-radius: 50px;
            cursor: pointer; transition: 0.3s; margin-top: 20px;
            font-weight: bold; text-transform: uppercase;
        }
        .btn:hover { background: var(--rojo); transform: scale(1.05); }

        /* --- CONTROLES MÓVILES --- */
        #controls {
            display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px);
            gap: 10px; margin-top: 20px;
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--oro);
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: var(--oro); cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="game-header">
        <div class="stat-box">Nivel: <span id="lvl-val">1</span>/10</div>
        <div class="stat-box">Puntos: <span id="score-val">0</span></div>
        <div class="stat-box">Vidas: <span id="lives-val">3</span></div>
    </div>

    <div id="game-container">
        <canvas id="pacCanvas"></canvas>
    </div>

    <div id="menu-screen" class="overlay">
        <h1>CAMINO A BELÉN</h1>
        <p>Recolecta las velitas, estrellas y arbolitos para encender el camino. ¡Evita a los enemigos que quieren apagar la Navidad!</p>
        <button class="btn" onclick="startGame()">Empezar Misión</button>
    </div>

    <div id="msg-screen" class="overlay" style="display: none;">
        <h1 id="msg-title">¡NIVEL SUPERADO!</h1>
        <p id="msg-body">Siguiente nivel en camino...</p>
        <button class="btn" id="msg-btn">Continuar</button>
    </div>

    <div id="controls">
        <div style="grid-column: 2" class="ctrl-btn" onmousedown="setDir(0, -1)">↑</div>
        <div style="grid-row: 2; grid-column: 1" class="ctrl-btn" onmousedown="setDir(-1, 0)">←</div>
        <div style="grid-row: 2; grid-column: 2" class="ctrl-btn" onmousedown="setDir(0, 1)">↓</div>
        <div style="grid-row: 2; grid-column: 3" class="ctrl-btn" onmousedown="setDir(1, 0)">→</div>
    </div>

    <script>
        const canvas = document.getElementById('pacCanvas');
        const ctx = canvas.getContext('2d');
        const TILE_SIZE = 20;
        
        // --- CONFIGURACIÓN DEL JUEGO ---
        let score = 0;
        let level = 1;
        let lives = 3;
        let gameActive = false;
        let pellets = [];
        let powerPellets = []; // Estrellas que dan poder
        let ghosts = [];
        
        // Mapa simplificado (1 = Pared, 0 = Punto/Velita, 2 = Vacío, 3 = Estrella Poder, 4 = Árbol Bonus)
        const baseMap = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,3,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,3,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],
            [2,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,2],
            [1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],
            [2,2,2,2,0,2,2,1,2,2,2,1,2,2,0,2,2,2,2],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
            [2,2,2,1,0,1,2,2,2,4,2,2,2,1,0,1,2,2,2],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,3,0,1,0,0,0,0,0,2,0,0,0,0,0,1,0,3,1],
            [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        let map = JSON.parse(JSON.stringify(baseMap));
        canvas.width = map[0].length * TILE_SIZE;
        canvas.height = map.length * TILE_SIZE;

        const player = {
            x: 9 * TILE_SIZE, y: 15 * TILE_SIZE,
            dirX: 0, dirY: 0,
            nextDirX: 0, nextDirY: 0,
            speed: 2, radius: 8,
            mouth: 0,
            powerUp: 0 // Tiempo de invencibilidad
        };

        function createGhosts() {
            ghosts = [];
            const colors = ['#FF0000', '#FFB8FF', '#00FFFF', '#FFB852'];
            for(let i=0; i < Math.min(level + 1, 4); i++) {
                ghosts.push({
                    x: 9 * TILE_SIZE, y: 9 * TILE_SIZE,
                    dirX: 1, dirY: 0,
                    color: colors[i],
                    speed: 1 + (level * 0.2),
                    scared: false
                });
            }
        }

        function setDir(x, y) {
            player.nextDirX = x;
            player.nextDirY = y;
        }

        // --- MOTOR LÓGICO ---
        function update() {
            if(!gameActive) return;

            // Movimiento Jugador (Pac-man Elías)
            if(player.x % TILE_SIZE === 0 && player.y % TILE_SIZE === 0) {
                const gridX = player.x / TILE_SIZE;
                const gridY = player.y / TILE_SIZE;

                // Cambiar dirección si es posible
                if(map[gridY + player.nextDirY] && map[gridY + player.nextDirY][gridX + player.nextDirX] !== 1) {
                    player.dirX = player.nextDirX;
                    player.dirY = player.nextDirY;
                }
                
                // Detenerse ante paredes
                if(map[gridY + player.dirY][gridX + player.dirX] === 1) {
                    player.dirX = 0;
                    player.dirY = 0;
                }

                // Recolección
                const cell = map[gridY][gridX];
                if(cell === 0) { map[gridY][gridX] = 2; score += 10; checkWin(); }
                if(cell === 3) { // Estrella de Poder
                    map[gridY][gridX] = 2; score += 50; 
                    player.powerUp = 300; 
                    ghosts.forEach(g => g.scared = true);
                }
                if(cell === 4) { map[gridY][gridX] = 2; score += 100; }
            }

            player.x += player.dirX * player.speed;
            player.y += player.dirY * player.speed;
            if(player.powerUp > 0) player.powerUp--;
            if(player.powerUp === 0) ghosts.forEach(g => g.scared = false);

            // Fantasmas
            ghosts.forEach(g => {
                if(g.x % TILE_SIZE === 0 && g.y % TILE_SIZE === 0) {
                    const gx = g.x / TILE_SIZE;
                    const gy = g.y / TILE_SIZE;
                    const dirs = [[0,1],[0,-1],[1,0],[-1,0]];
                    // Inteligencia básica: elegir dirección aleatoria que no sea pared
                    let validDirs = dirs.filter(d => map[gy + d[1]][gx + d[0]] !== 1);
                    let choice = validDirs[Math.floor(Math.random() * validDirs.length)];
                    g.dirX = choice[0]; g.dirY = choice[1];
                }
                g.x += g.dirX * g.speed;
                g.y += g.dirY * g.speed;

                // Colisión con jugador
                let dist = Math.hypot(player.x - g.x, player.y - g.y);
                if(dist < TILE_SIZE) {
                    if(g.scared) {
                        g.x = 9 * TILE_SIZE; g.y = 9 * TILE_SIZE;
                        score += 200;
                        g.scared = false;
                    } else {
                        resetPlayer();
                    }
                }
            });

            document.getElementById('score-val').innerText = score;
        }

        // --- RENDERIZADO ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dibujar Mapa
            for(let y=0; y < map.length; y++) {
                for(let x=0; x < map[y].length; x++) {
                    const cell = map[y][x];
                    if(cell === 1) {
                        ctx.fillStyle = '#10294c';
                        ctx.fillRect(x*TILE_SIZE+2, y*TILE_SIZE+2, TILE_SIZE-4, TILE_SIZE-4);
                    } else if(cell === 0) { // Velita
                        ctx.fillStyle = '#6A0573';
                        ctx.fillRect(x*TILE_SIZE+8, y*TILE_SIZE+6, 4, 10); // Cera
                        ctx.fillStyle = '#FFD700';
                        ctx.fillRect(x*TILE_SIZE+9, y*TILE_SIZE+2, 2, 4);  // Llama
                    } else if(cell === 3) { // Estrella
                        drawStar(x*TILE_SIZE + 10, y*TILE_SIZE + 10, 5, 8, 4, '#FFD700');
                    } else if(cell === 4) { // Arbolito
                        ctx.fillStyle = '#004d40';
                        ctx.beginPath();
                        ctx.moveTo(x*TILE_SIZE+10, y*TILE_SIZE+2);
                        ctx.lineTo(x*TILE_SIZE+4, y*TILE_SIZE+15);
                        ctx.lineTo(x*TILE_SIZE+16, y*TILE_SIZE+15);
                        ctx.fill();
                    }
                }
            }

            // Dibujar Personaje (Pac-man)
            ctx.fillStyle = player.powerUp > 0 ? '#FFF' : '#FFD700';
            ctx.beginPath();
            let angle = (Math.sin(Date.now() / 100) + 1) * 0.2;
            ctx.arc(player.x + 10, player.y + 10, 9, angle * Math.PI, (2 - angle) * Math.PI);
            ctx.lineTo(player.x + 10, player.y + 10);
            ctx.fill();

            // Dibujar Fantasmas
            ghosts.forEach(g => {
                ctx.fillStyle = g.scared ? '#4a69bd' : g.color;
                ctx.beginPath();
                ctx.arc(g.x+10, g.y+10, 9, Math.PI, 0);
                ctx.lineTo(g.x+19, g.y+19);
                ctx.lineTo(g.x+1, g.y+19);
                ctx.fill();
                // Ojos
                ctx.fillStyle = 'white';
                ctx.fillRect(g.x+5, g.y+6, 3, 3);
                ctx.fillRect(g.x+12, g.y+6, 3, 3);
            });

            requestAnimationFrame(() => { update(); draw(); });
        }

        function drawStar(cx, cy, spikes, outerRadius, innerRadius, color) {
            let rot = Math.PI / 2 * 3;
            let x = cx; let y = cy;
            let step = Math.PI / spikes;
            ctx.beginPath(); ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                x = cx + Math.cos(rot) * outerRadius; y = cy + Math.sin(rot) * outerRadius;
                ctx.lineTo(x, y); rot += step;
                x = cx + Math.cos(rot) * innerRadius; y = cy + Math.sin(rot) * innerRadius;
                ctx.lineTo(x, y); rot += step;
            }
            ctx.lineTo(cx, cy - outerRadius); ctx.closePath();
            ctx.fillStyle = color; ctx.fill();
        }

        // --- SISTEMA DE JUEGO ---
        function resetPlayer() {
            lives--;
            document.getElementById('lives-val').innerText = lives;
            if(lives <= 0) {
                gameOver(false);
            } else {
                player.x = 9 * TILE_SIZE; player.y = 15 * TILE_SIZE;
                player.dirX = 0; player.dirY = 0;
            }
        }

        function checkWin() {
            let remaining = 0;
            map.forEach(row => row.forEach(cell => { if(cell === 0) remaining++; }));
            if(remaining === 0) {
                if(level < 10) {
                    level++;
                    showStatus("¡NIVEL SUPERADO!", "La fe crece y la luz brilla más fuerte.", "Siguiente Nivel", () => {
                        map = JSON.parse(JSON.stringify(baseMap));
                        createGhosts();
                        player.x = 9 * TILE_SIZE; player.y = 15 * TILE_SIZE;
                        document.getElementById('lvl-val').innerText = level;
                        gameActive = true;
                    });
                } else {
                    gameOver(true);
                }
            }
        }

        function showStatus(title, body, btnTxt, action) {
            gameActive = false;
            const screen = document.getElementById('msg-screen');
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-body').innerText = body;
            const btn = document.getElementById('msg-btn');
            btn.innerText = btnTxt;
            btn.onclick = () => { screen.style.display = 'none'; action(); };
            screen.style.display = 'flex';
        }

        function gameOver(win) {
            showStatus(
                win ? "¡MISIÓN CUMPLIDA!" : "LAMENTABLE...",
                win ? "Has llevado la luz a todos los rincones de Belén. ¡Feliz Navidad!" : "Las luces se apagaron. Inténtalo de nuevo.",
                "Reiniciar Todo",
                () => location.reload()
            );
        }

        function startGame() {
            document.getElementById('menu-screen').style.display = 'none';
            createGhosts();
            gameActive = true;
            draw();
        }

        // Controles de teclado
        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowUp') setDir(0, -1);
            if(e.key === 'ArrowDown') setDir(0, 1);
            if(e.key === 'ArrowLeft') setDir(-1, 0);
            if(e.key === 'ArrowRight') setDir(1, 0);
        });
    </script>
</body>
</html>
