<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pac-Man Navideño | 5 Niveles</title>
    <style>
        :root { --noche: #0A192F; --adviento: #6A0573; --oro: #FFD700; --nieve: #F0F8FF; }
        body { margin: 0; background: var(--noche); font-family: 'Segoe UI', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; overflow: hidden; touch-action: none; }
        #header { width: 100%; padding: 10px; background: var(--adviento); display: flex; justify-content: space-around; border-bottom: 3px solid var(--oro); font-weight: bold; z-index: 10; }
        #canvas-wrap { margin-top: 10px; border: 4px solid var(--adviento); background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        canvas { display: block; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 25, 47, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; text-align: center; }
        .btn { background: var(--adviento); color: white; border: 2px solid var(--oro); padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; margin-top: 20px; font-weight: bold; text-transform: uppercase; }
        #controls { display: grid; grid-template-columns: repeat(3, 75px); gap: 10px; margin-top: 15px; padding-bottom: 20px; }
        .ctrl-btn { background: rgba(255,255,255,0.1); border: 2px solid var(--oro); border-radius: 20px; height: 70px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: var(--oro); user-select: none; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>

    <div id="header">
        <div>NIVEL: <span id="lvl">1</span>/5</div>
        <div>VIDAS: <span id="vds">3</span></div>
        <div>PUNTOS: <span id="pts">0</span></div>
    </div>

    <div id="canvas-wrap">
        <canvas id="gCanvas"></canvas>
    </div>

    <div id="scr-start" class="overlay">
        <h1 style="color:var(--oro); font-size: 2.5rem;">BELÉN QUEST</h1>
        <p>Recoge las luces para completar los 5 niveles.</p>
        <button class="btn" onclick="initGame()">¡EMPEZAR!</button>
    </div>

    <div id="scr-msg" class="overlay" style="display:none">
        <h1 id="msg-t" style="color:var(--oro)"></h1>
        <p id="msg-b" style="font-size: 1.4rem; padding: 0 20px;"></p>
        <button id="msg-btn" class="btn">CONTINUAR</button>
    </div>

    <div id="controls">
        <div style="grid-column:2" class="ctrl-btn" onmousedown="handleInput(0,-1)" ontouchstart="handleInput(0,-1)">↑</div>
        <div style="grid-row:2;grid-column:1" class="ctrl-btn" onmousedown="handleInput(-1,0)" ontouchstart="handleInput(-1,0)">←</div>
        <div style="grid-row:2;grid-column:2" class="ctrl-btn" onmousedown="handleInput(0,1)" ontouchstart="handleInput(0,1)">↓</div>
        <div style="grid-row:2;grid-column:3" class="ctrl-btn" onmousedown="handleInput(1,0)" ontouchstart="handleInput(1,0)">→</div>
    </div>

    <script>
        const cvs = document.getElementById('gCanvas');
        const ctx = cvs.getContext('2d');
        const T = 20; 
        let score=0, level=1, lives=3, active=false;
        let map=[], ghosts=[], player={};

        const baseLayout = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,3,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,3,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],[1,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,1],
            [1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],[0,0,0,0,0,2,2,1,2,2,2,1,2,2,0,0,0,0,0],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,1],
            [1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,3,0,1,0,0,0,0,0,2,0,0,0,0,0,1,0,3,1],
            [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        function handleInput(x, y) {
            if(!active) return;
            player.nextDx = x;
            player.nextDy = y;
        }

        function resetEntities(resetMap) {
            if(resetMap) map = JSON.parse(JSON.stringify(baseLayout));
            
            // Alineación forzada para evitar descalibración
            player = {
                x: 9 * T, y: 15 * T,
                dx: 0, dy: 0, nextDx: 0, nextDy: 0,
                speed: 2, pwr: 0
            };

            const colors = ['#FF0000','#FFB8FF','#00FFFF','#FFB852'];
            // Dificultad escala con el nivel
            const ghostSpeed = 1.4 + (level * 0.3); 
            
            ghosts = colors.map((c) => ({
                x: 9 * T, y: 9 * T,
                dx: 0, dy: 0,
                col: c,
                speed: ghostSpeed
            }));
        }

        function update() {
            if(!active) return;

            // Movimiento Pacman
            if(player.x % T === 0 && player.y % T === 0) {
                const cx = Math.round(player.x / T);
                const cy = Math.round(player.y / T);

                // Cambiar dirección si es posible
                if(map[cy + player.nextDy] && map[cy + player.nextDy][cx + player.nextDx] !== 1) {
                    player.dx = player.nextDx;
                    player.dy = player.nextDy;
                }
                // Chocar con pared
                if(map[cy + player.dy] && map[cy + player.dy][cx + player.dx] === 1) {
                    player.dx = 0; player.dy = 0;
                }

                // Recoger puntos
                if(map[cy][cx] === 0) { map[cy][cx] = 2; score += 10; checkWin(); }
                if(map[cy][cx] === 3) { map[cy][cx] = 2; player.pwr = 450; score += 50; }
            }

            player.x += player.dx * player.speed;
            player.y += player.dy * player.speed;

            // Túneles laterales
            if(player.x < 0) player.x = cvs.width - T;
            if(player.x >= cvs.width) player.x = 0;

            // Movimiento Fantasmas
            ghosts.forEach(g => {
                if(Math.abs(g.x % T) < g.speed && Math.abs(g.y % T) < g.speed) {
                    g.x = Math.round(g.x / T) * T;
                    g.y = Math.round(g.y / T) * T;
                    const gx = g.x / T, gy = g.y / T;

                    const dirs = [[0,1],[0,-1],[1,0],[-1,0]].filter(d => 
                        map[gy + d[1]] && map[gy + d[1]][gx + d[0]] !== 1
                    );

                    // IA básica: No volver atrás a menos que sea necesario
                    let forward = dirs.filter(d => !(d[0] === -g.dx && d[1] === -g.dy));
                    let final = (forward.length > 0 ? forward : dirs)[Math.floor(Math.random() * (forward.length || 1))];
                    
                    if(final) { g.dx = final[0]; g.dy = final[1]; }
                }
                g.x += g.dx * g.speed;
                g.y += g.dy * g.speed;

                // Colisiones
                if(Math.hypot(player.x - g.x, player.y - g.y) < T * 0.8) {
                    if(player.pwr > 0) {
                        g.x = 9 * T; g.y = 9 * T; score += 200;
                    } else {
                        gameOver(false);
                    }
                }
            });

            if(player.pwr > 0) player.pwr--;
            document.getElementById('pts').innerText = score;
        }

        function draw() {
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            // Dibujar Laberinto
            for(let y=0; y<map.length; y++) {
                for(let x=0; x<map[y].length; x++) {
                    const cell = map[y][x];
                    if(cell === 1) {
                        ctx.fillStyle = '#10294c';
                        ctx.fillRect(x*T+2, y*T+2, T-4, T-4);
                    } else if(cell === 0) {
                        ctx.fillStyle = '#FFD700';
                        ctx.beginPath(); ctx.arc(x*T+T/2, y*T+T/2, 2, 0, 7); ctx.fill();
                    } else if(cell === 3) {
                        ctx.fillStyle = '#FFF';
                        ctx.beginPath(); ctx.arc(x*T+T/2, y*T+T/2, 5, 0, 7); ctx.fill();
                    }
                }
            }
            // Dibujar Pacman
            ctx.fillStyle = player.pwr > 100 || (player.pwr > 0 && player.pwr % 20 < 10) ? '#FFF' : '#FFD700';
            ctx.beginPath();
            let mouth = (Math.sin(Date.now() / 100) + 1) * 0.2;
            ctx.arc(player.x+T/2, player.y+T/2, 8, mouth * Math.PI, (2 - mouth) * Math.PI);
            ctx.lineTo(player.x+T/2, player.y+T/2);
            ctx.fill();

            // Dibujar Fantasmas
            ghosts.forEach(g => {
                ctx.fillStyle = player.pwr > 0 ? '#44F' : g.col;
                ctx.beginPath(); ctx.arc(g.x+T/2, g.y+T/2, 8, Math.PI, 0);
                ctx.lineTo(g.x+T-2, g.y+T-2); ctx.lineTo(g.x+2, g.y+T-2); ctx.fill();
                // Ojos básicos
                ctx.fillStyle = "white"; ctx.fillRect(g.x+5, g.y+5, 2, 2); ctx.fillRect(g.x+13, g.y+5, 2, 2);
            });
            if(active) requestAnimationFrame(draw);
        }

        function gameOver(win) {
            active = false;
            if(!win) {
                lives--;
                document.getElementById('vds').innerText = lives;
                if(lives > 0) {
                    showStatus("¡UPS!", "Un fantasma te ha atrapado. Te quedan " + lives + " vidas.", "CONTINUAR", () => {
                        resetEntities(false); active = true; draw();
                    });
                } else {
                    showStatus("FIN DEL JUEGO", "Has perdido todas las vidas. Puntos: " + score, "REINTENTAR", () => location.reload());
                }
            }
        }

        function checkWin() {
            let dots = 0;
            map.forEach(r => r.forEach(c => { if(c === 0) dots++; }));
            if(dots === 0) {
                active = false;
                if(level < 5) {
                    level++;
                    showStatus("¡NIVEL " + (level-1) + " COMPLETADO!", "La dificultad aumenta. ¡Vamos al Nivel " + level + "!", "SIGUIENTE", () => {
                        resetEntities(true);
                        document.getElementById('lvl').innerText = level;
                        active = true; draw();
                    });
                } else {
                    showStatus("¡VICTORIA TOTAL!", "Has completado los 5 niveles. ¡La Navidad está a salvo!", "JUGAR DE NUEVO", () => location.reload());
                }
            }
        }

        function showStatus(t, b, bt, action) {
            document.getElementById('msg-t').innerText = t;
            document.getElementById('msg-b').innerText = b;
            const btn = document.getElementById('msg-btn');
            btn.innerText = bt;
            btn.onclick = () => { document.getElementById('scr-msg').style.display='none'; action(); };
            document.getElementById('scr-msg').style.display='flex';
        }

        function initGame() {
            document.getElementById('scr-start').style.display='none';
            cvs.width = 19 * T; cvs.height = 19 * T;
            resetEntities(true);
            active = true;
            setInterval(update, 1000/60); // Lógica separada constante
            draw();
        }

        window.addEventListener('keydown', e => {
            if(e.key === 'ArrowUp') handleInput(0, -1);
            if(e.key === 'ArrowDown') handleInput(0, 1);
            if(e.key === 'ArrowLeft') handleInput(-1, 0);
            if(e.key === 'ArrowRight') handleInput(1, 0);
        });
    </script>
</body>
</html>
